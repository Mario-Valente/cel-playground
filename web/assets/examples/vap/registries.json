{
  "code": "apiVersion: admissionregistration.k8s.io/v1beta1\nkind: ValidatingAdmissionPolicy\nmetadata:\n  name: \"allowed-registries\"\nspec:\n  failurePolicy: Fail\n  matchConstraints:\n    resourceRules:\n      - apiGroups: [ \"\", \"apps\", \"batch\" ]\n        apiVersions: [ \"v1\" ]\n        operations: [ \"CREATE\", \"UPDATE\" ]\n        resources: [ \"pods\", \"deployments\", \"daemonsets\", \"statefulsets\", \"replicasets\", \"cronjobs\", \"jobs\" ]\n  paramKind:\n    apiVersion: v1\n    kind: ConfigMap\n  variables:\n    - name: allowedRegistries\n      expression: 'params.data.allowedRegistries.split(\",\")'\n    - name: podSpec\n      expression: >\n        object.kind == \"Pod\" ? object.spec : (\n            object.kind in [\"ReplicaSet\", \"Deployment\", \"DaemonSet\", \"StatefulSet\", \"Job\"] ? object.spec.template.spec : (\n                object.kind == \"CronJob\" ? object.spec.jobTemplate.spec.template.spec : null)\n        )\n    - name: allContainers\n      expression: 'variables.podSpec.containers + variables.podSpec.?initContainers.orValue([])'\n  validations:\n    - expression: >\n        variables.allContainers.all(c,\n          variables.allowedRegistries.exists(i, c.image.startsWith(i))\n        )\n      message: \"Forbidden image registry\"\n",
  "inputs": {
    "object": "apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx\n  labels:\n    app: nginx\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      name: nginx\n      labels:\n        app: nginx\n    spec:\n      containers:\n        - name: nginx\n          image: nginx\n#          image: cgr.dev/chainguard/nginx\n          imagePullPolicy: IfNotPresent\n      restartPolicy: Always",
    "oldObject": "",
    "params": "apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: default-allowed-registries\ndata:\n  allowedRegistries: \"cgr.dev,mycompany.com\""
  }
}